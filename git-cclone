#!/bin/bash

error() { echo "ERROR(git-cclone): $*" >&2; exit 1; }
info() { echo "INFO(git-cclone): $*" >&2; }

[[ -r ~/.gitcache.conf ]] && . ~/.gitcache.conf

[[ -z "$GIT_CACHE_SERVER" ]] && error "variable GIT_CACHE_SERVER undefined"

repo="$1"
dir="${2:-$(basename $repo .git)}"
mirror=$3 # optional --mirror (used by git-crecover) or --bare (can be set by user)

[[ -d "$dir" ]] && error "directory $dir exists"

info "asking $GIT_CACHE_SERVER a cache for $repo"
crepo="${GIT_CACHE_SERVER}:$(ssh "$GIT_CACHE_SERVER" gitcache-server --clone "$repo")"
[[ -z "$crepo" ]] && error "can't get a cache"

info "cache for $repo is $crepo"

info "cloning $crepo into $dir"
git clone $mirror "$crepo" "$dir" >&2

info "init of git $dir"
cd "$dir"
git remote set-url --push origin "$repo" >&2
git config remote.origin.uploadpack gitcache-server >&2
info "done"

